# Story 11.1: Rotate Exposed Credentials

## Story
**As a** system administrator
**I want to** rotate all exposed API credentials
**So that** compromised keys cannot be used by attackers

## Priority: CRITICAL
## Points: 2

## Background

Security audit discovered that production API keys were committed to the git repository in the `.env` file:
- Line 9: `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase anonymous JWT
- Line 13: `SUPABASE_SERVICE_ROLE_KEY` - Supabase admin key (most critical)
- Line 19: `ANTHROPIC_API_KEY` - Anthropic API key

Even if the file is deleted, credentials remain in git history and could be extracted by anyone with repository access.

## Acceptance Criteria

- [ ] All Supabase keys rotated in Supabase dashboard
- [ ] Anthropic API key rotated in Anthropic console
- [ ] Old credentials invalidated/revoked
- [ ] `.env` file removed from git history
- [ ] New credentials deployed to production environment
- [ ] Application verified working with new credentials
- [ ] `.gitignore` verified to exclude `.env` files
- [ ] Team notified of credential rotation

## Technical Details

### Step 1: Rotate Supabase Keys
1. Go to Supabase Dashboard → Project Settings → API
2. Click "Regenerate anon key"
3. Click "Regenerate service_role key"
4. Copy new keys securely

### Step 2: Rotate Anthropic API Key
1. Go to Anthropic Console → API Keys
2. Create new API key
3. Delete old API key
4. Copy new key securely

### Step 3: Remove .env from Git History
```bash
# Option A: BFG Repo-Cleaner (faster, recommended)
bfg --delete-files .env
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# Option B: git filter-branch
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch .env" \
  --prune-empty --tag-name-filter cat -- --all
git reflog expire --expire=now --all
git gc --prune=now --aggressive
```

### Step 4: Force Push (Coordinate with Team!)
```bash
git push origin --force --all
git push origin --force --tags
```

### Step 5: Update Production Environment
- Update environment variables in deployment platform (Vercel/Netlify)
- Verify application starts correctly
- Test critical functionality (chat API, database access)

## Verification

```bash
# Verify .env not in history
git log --all --full-history -- .env
# Should return empty

# Verify .gitignore
cat .gitignore | grep -E "^\.env"
# Should show .env entries
```

## Dependencies
- None

## Risks
- **Downtime during rotation:** Minimize by preparing new keys first
- **Team disruption:** Coordinate timing, notify all developers
- **Forgotten deployment:** Verify all environments updated

## Notes
- Document new key locations securely
- Consider using a secrets manager for future
- Set up key rotation reminders (quarterly)
