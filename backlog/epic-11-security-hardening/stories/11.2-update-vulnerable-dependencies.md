# Story 11.2: Update Vulnerable Dependencies

## Story
**As a** developer
**I want to** update all vulnerable npm dependencies
**So that** known security vulnerabilities are patched

## Priority: CRITICAL
## Points: 3

## Background

Security audit identified vulnerable dependencies:

### Critical: AI SDK File Upload Bypass
- **Package:** `ai` (current: ^4.3.19)
- **Vulnerability:** GHSA-rwvc-j5jr-mgvh
- **Risk:** File type whitelist can be bypassed during uploads
- **Fix:** Update to `ai@^6.0.44` or higher

### Moderate: jsondiffpatch XSS
- **Package:** `jsondiffpatch` (transitive dependency)
- **Vulnerability:** GHSA-33vc-wfww-vjfv
- **Risk:** XSS via HtmlFormatter
- **Fix:** Resolved by updating AI SDK

## Acceptance Criteria

- [ ] AI SDK updated to ^6.0.44 or latest secure version
- [ ] `npm audit` shows 0 vulnerabilities
- [ ] All tests pass after update
- [ ] File upload functionality verified working
- [ ] Chat functionality verified working
- [ ] Breaking changes documented and addressed

## Technical Details

### Update Commands
```bash
# Check current vulnerabilities
npm audit

# Update AI SDK
npm install ai@latest

# Update all dependencies to latest compatible versions
npm update

# Check for remaining issues
npm audit

# If issues remain, try fix
npm audit fix
```

### Breaking Changes (AI SDK v4 â†’ v6)

The AI SDK v6 introduces breaking changes. Review the [migration guide](https://sdk.vercel.ai/docs/migration-guides).

Key changes to verify:
1. Stream response format changes
2. Message type definitions
3. Tool/function calling interface
4. Error handling patterns

### Files to Update/Test

1. `src/app/api/chat/route.ts` - Chat API endpoint
2. `src/components/chat/ai-chat.tsx` - Chat UI component
3. `src/app/documents/[slug]/document-chat.tsx` - Document chat
4. `src/hooks/use-file-upload.ts` - File upload hook

### Testing Checklist

```bash
# Run tests
npm test

# Manual testing
1. Open chat interface
2. Send a message, verify response streams
3. Upload a PDF document
4. Ask question about uploaded document
5. Verify file type restrictions work
6. Test invalid file rejection
```

## Verification

```bash
# Verify no vulnerabilities
npm audit
# Expected: found 0 vulnerabilities

# Verify AI SDK version
npm list ai
# Expected: ai@6.x.x or higher
```

## Dependencies
- None

## Risks
- **Breaking changes:** Thoroughly test all chat/upload functionality
- **Regression:** Run full test suite before deploying
- **Rollback plan:** Keep previous package-lock.json for quick rollback

## Notes
- This is a breaking change update - allocate extra testing time
- Consider updating in staging first
- Monitor error rates after deployment
