# Story 11.6: Add Security Middleware

## Story
**As a** developer
**I want to** implement Next.js security middleware
**So that** security checks are applied to all requests consistently

## Priority: HIGH
## Points: 5

## Background

No `middleware.ts` exists in the application. Security middleware provides:
- CSRF protection
- Origin validation
- Request logging
- Security header backup
- Route protection

## Acceptance Criteria

- [ ] Middleware file created at `src/middleware.ts`
- [ ] CSRF/origin validation for API routes
- [ ] Security headers applied as backup
- [ ] Request logging for security events
- [ ] Configurable via environment variables
- [ ] Does not break existing functionality

## Technical Details

```typescript
// src/middleware.ts
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export function middleware(request: NextRequest) {
  const response = NextResponse.next();
  const { pathname } = request.nextUrl;

  // Security headers (backup to next.config.ts)
  response.headers.set("X-Content-Type-Options", "nosniff");
  response.headers.set("X-Frame-Options", "DENY");
  response.headers.set("X-XSS-Protection", "1; mode=block");

  // API route protection
  if (pathname.startsWith("/api/")) {
    // Validate origin for non-GET requests
    if (request.method !== "GET") {
      const origin = request.headers.get("origin");
      const host = request.headers.get("host");

      // Allow same-origin requests
      if (origin && host && !origin.includes(host)) {
        console.warn(`CSRF attempt blocked: origin=${origin}, host=${host}`);
        return new NextResponse(
          JSON.stringify({ error: "Invalid origin" }),
          { status: 403, headers: { "Content-Type": "application/json" } }
        );
      }
    }

    // Log API requests (minimal info)
    console.log(`[API] ${request.method} ${pathname}`);
  }

  return response;
}

export const config = {
  matcher: [
    // Match all paths except static files
    "/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
  ],
};
```

## Dependencies
- Story 11.5 (Security Headers)

## Points: 5
