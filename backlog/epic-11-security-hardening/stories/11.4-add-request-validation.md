# Story 11.4: Add Request Validation Schema

## Story
**As a** developer
**I want to** validate all API request payloads with schemas
**So that** malformed or malicious requests are rejected before processing

## Priority: HIGH
## Points: 5

## Background

The chat API currently accepts request bodies without validation:
```typescript
const { messages, attachedDocument } = await req.json();
```

This creates risks:
- Prototype pollution attacks
- Buffer overflow with oversized payloads
- Type confusion errors
- Injection through unexpected data structures

## Acceptance Criteria

- [ ] Zod schemas defined for all API request types
- [ ] Chat API validates messages array structure
- [ ] Chat API validates attachedDocument structure
- [ ] Appropriate error messages returned for validation failures
- [ ] Size limits enforced server-side
- [ ] Type safety ensured throughout request handling
- [ ] Unit tests for validation schemas

## Technical Details

### Schema Definitions

```typescript
// src/lib/validation/schemas.ts
import { z } from "zod";

// Message schema
export const MessageSchema = z.object({
  id: z.string().optional(),
  role: z.enum(["user", "assistant"]),
  content: z.string()
    .min(1, "Message cannot be empty")
    .max(10000, "Message too long (max 10,000 characters)"),
  createdAt: z.date().optional(),
});

// Attached document schema
export const AttachedDocumentSchema = z.object({
  name: z.string()
    .min(1)
    .max(255, "Filename too long")
    .regex(/^[a-zA-Z0-9._-]+$/, "Invalid filename characters"),
  type: z.enum(["application/pdf", "text/plain", "text/markdown", ".pdf", ".txt", ".md"]),
  content: z.string()
    .max(50000, "Document content too large (max 50,000 characters)"),
  size: z.number()
    .int()
    .positive()
    .max(5 * 1024 * 1024, "File too large (max 5MB)"),
});

// Chat request schema
export const ChatRequestSchema = z.object({
  messages: z.array(MessageSchema)
    .min(1, "At least one message required")
    .max(100, "Too many messages (max 100)"),
  attachedDocument: AttachedDocumentSchema.optional(),
});

// Type exports
export type Message = z.infer<typeof MessageSchema>;
export type AttachedDocument = z.infer<typeof AttachedDocumentSchema>;
export type ChatRequest = z.infer<typeof ChatRequestSchema>;
```

### Validation Helper

```typescript
// src/lib/validation/validate.ts
import { z, ZodError } from "zod";

export interface ValidationResult<T> {
  success: boolean;
  data?: T;
  error?: {
    message: string;
    details: Array<{ path: string; message: string }>;
  };
}

export function validateRequest<T>(
  schema: z.ZodSchema<T>,
  data: unknown
): ValidationResult<T> {
  try {
    const validated = schema.parse(data);
    return { success: true, data: validated };
  } catch (err) {
    if (err instanceof ZodError) {
      return {
        success: false,
        error: {
          message: "Validation failed",
          details: err.errors.map((e) => ({
            path: e.path.join("."),
            message: e.message,
          })),
        },
      };
    }
    return {
      success: false,
      error: {
        message: "Unknown validation error",
        details: [],
      },
    };
  }
}
```

### Updated Chat Route

```typescript
// src/app/api/chat/route.ts
import { ChatRequestSchema } from "@/lib/validation/schemas";
import { validateRequest } from "@/lib/validation/validate";

export async function POST(req: Request) {
  try {
    // Parse and validate request
    const body = await req.json();
    const validation = validateRequest(ChatRequestSchema, body);

    if (!validation.success) {
      return new Response(
        JSON.stringify({
          error: "Invalid request",
          details: validation.error?.details,
        }),
        {
          status: 400,
          headers: { "Content-Type": "application/json" },
        }
      );
    }

    const { messages, attachedDocument } = validation.data!;

    // Now safely use validated data...
  } catch (error) {
    // Handle JSON parse errors
    if (error instanceof SyntaxError) {
      return new Response(
        JSON.stringify({ error: "Invalid JSON in request body" }),
        { status: 400, headers: { "Content-Type": "application/json" } }
      );
    }
    throw error;
  }
}
```

### Unit Tests

```typescript
// src/lib/validation/__tests__/schemas.test.ts
import { describe, it, expect } from "vitest";
import { ChatRequestSchema, MessageSchema } from "../schemas";

describe("MessageSchema", () => {
  it("accepts valid user message", () => {
    const result = MessageSchema.safeParse({
      role: "user",
      content: "Hello",
    });
    expect(result.success).toBe(true);
  });

  it("rejects empty content", () => {
    const result = MessageSchema.safeParse({
      role: "user",
      content: "",
    });
    expect(result.success).toBe(false);
  });

  it("rejects invalid role", () => {
    const result = MessageSchema.safeParse({
      role: "admin",
      content: "Hello",
    });
    expect(result.success).toBe(false);
  });

  it("rejects oversized content", () => {
    const result = MessageSchema.safeParse({
      role: "user",
      content: "x".repeat(10001),
    });
    expect(result.success).toBe(false);
  });
});

describe("ChatRequestSchema", () => {
  it("accepts valid chat request", () => {
    const result = ChatRequestSchema.safeParse({
      messages: [{ role: "user", content: "Hello" }],
    });
    expect(result.success).toBe(true);
  });

  it("accepts request with attached document", () => {
    const result = ChatRequestSchema.safeParse({
      messages: [{ role: "user", content: "Hello" }],
      attachedDocument: {
        name: "test.pdf",
        type: "application/pdf",
        content: "Test content",
        size: 1024,
      },
    });
    expect(result.success).toBe(true);
  });

  it("rejects empty messages array", () => {
    const result = ChatRequestSchema.safeParse({
      messages: [],
    });
    expect(result.success).toBe(false);
  });
});
```

## Files to Create/Modify

| File | Action |
|------|--------|
| `src/lib/validation/schemas.ts` | Create |
| `src/lib/validation/validate.ts` | Create |
| `src/app/api/chat/route.ts` | Modify |
| `src/lib/validation/__tests__/schemas.test.ts` | Create |

## Dependencies
- `zod` (already installed)

## Risks
- **False rejections:** Overly strict schemas may reject valid requests
- **Performance:** Validation adds processing time (minimal with zod)

## Notes
- Consider adding rate of schema evolution to API versioning
- Log validation failures for debugging (not content)
- Future: Add OpenAPI spec generation from schemas
