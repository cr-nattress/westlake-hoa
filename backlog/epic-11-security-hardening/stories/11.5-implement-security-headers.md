# Story 11.5: Implement Security Headers

## Story
**As a** security engineer
**I want to** configure proper security headers
**So that** the application is protected against common web vulnerabilities

## Priority: HIGH
## Points: 3

## Background

Security audit revealed no security headers are configured:
- No Content Security Policy (CSP)
- No X-Frame-Options (clickjacking risk)
- No X-Content-Type-Options (MIME sniffing)
- No Strict-Transport-Security (HSTS)
- No Referrer-Policy
- No Permissions-Policy

## Acceptance Criteria

- [ ] Content-Security-Policy header configured
- [ ] X-Frame-Options set to DENY
- [ ] X-Content-Type-Options set to nosniff
- [ ] Strict-Transport-Security enabled
- [ ] Referrer-Policy configured
- [ ] Permissions-Policy restricts unused features
- [ ] All headers verified in browser DevTools
- [ ] SecurityHeaders.com scan passes (A grade)

## Technical Details

### Next.js Configuration

```typescript
// next.config.ts
import type { NextConfig } from "next";

const ContentSecurityPolicy = `
  default-src 'self';
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com;
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https: blob:;
  font-src 'self' data:;
  connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.anthropic.com;
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
  upgrade-insecure-requests;
`.replace(/\s{2,}/g, ' ').trim();

const securityHeaders = [
  {
    key: "Content-Security-Policy",
    value: ContentSecurityPolicy,
  },
  {
    key: "X-Content-Type-Options",
    value: "nosniff",
  },
  {
    key: "X-Frame-Options",
    value: "DENY",
  },
  {
    key: "X-XSS-Protection",
    value: "1; mode=block",
  },
  {
    key: "Strict-Transport-Security",
    value: "max-age=31536000; includeSubDomains; preload",
  },
  {
    key: "Referrer-Policy",
    value: "strict-origin-when-cross-origin",
  },
  {
    key: "Permissions-Policy",
    value: "geolocation=(), microphone=(), camera=(), payment=(), usb=()",
  },
];

const nextConfig: NextConfig = {
  reactCompiler: true,
  async headers() {
    return [
      {
        source: "/(.*)",
        headers: securityHeaders,
      },
    ];
  },
};

export default nextConfig;
```

### Header Explanations

| Header | Value | Purpose |
|--------|-------|---------|
| Content-Security-Policy | See above | Prevents XSS, injection attacks |
| X-Content-Type-Options | nosniff | Prevents MIME type sniffing |
| X-Frame-Options | DENY | Prevents clickjacking |
| X-XSS-Protection | 1; mode=block | Legacy XSS filter (browsers) |
| Strict-Transport-Security | max-age=31536000 | Forces HTTPS for 1 year |
| Referrer-Policy | strict-origin-when-cross-origin | Controls referrer info |
| Permissions-Policy | geolocation=(), etc | Disables unused browser features |

### CSP Directives Explained

| Directive | Value | Reason |
|-----------|-------|--------|
| default-src | 'self' | Only load from same origin by default |
| script-src | 'self' 'unsafe-inline' 'unsafe-eval' | Next.js requires inline/eval |
| style-src | 'self' 'unsafe-inline' | Tailwind CSS needs inline styles |
| img-src | 'self' data: https: blob: | Images from self, data URIs, HTTPS |
| connect-src | 'self' https://*.supabase.co | API calls to self and Supabase |
| frame-ancestors | 'none' | Prevent embedding in iframes |

### Netlify Configuration (if deployed there)

```toml
# netlify.toml
[[headers]]
  for = "/*"
  [headers.values]
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' data:; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.anthropic.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests"
    X-Content-Type-Options = "nosniff"
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
```

## Verification

### Browser DevTools
1. Open DevTools â†’ Network tab
2. Reload page
3. Click on document request
4. Check Response Headers section
5. Verify all security headers present

### Online Scanners
- https://securityheaders.com - Enter site URL, expect A grade
- https://observatory.mozilla.org - Run scan

### curl Test
```bash
curl -I https://your-site.com

# Expected headers in response:
# content-security-policy: default-src 'self'...
# x-content-type-options: nosniff
# x-frame-options: DENY
# strict-transport-security: max-age=31536000...
```

## CSP Report-Only Mode (Recommended for Testing)

Before enforcing CSP, test with report-only:

```typescript
{
  key: "Content-Security-Policy-Report-Only",
  value: ContentSecurityPolicy,
},
```

Monitor console for CSP violations before switching to enforcing mode.

## Dependencies
- None

## Risks
- **CSP breaks functionality:** Test thoroughly, use report-only first
- **Third-party scripts blocked:** May need to whitelist additional sources
- **HSTS preload:** Only enable after confirming HTTPS works everywhere

## Notes
- PDF.js CDN (cdnjs.cloudflare.com) whitelisted in CSP
- Supabase WebSocket (wss://) needed for realtime features
- Consider adding CSP violation reporting endpoint
- Review CSP quarterly as dependencies change
