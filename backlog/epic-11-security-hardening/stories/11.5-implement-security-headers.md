# Story 11.5: Implement Security Headers

## Story
**As a** security engineer
**I want to** configure proper security headers
**So that** the application is protected against common web vulnerabilities

## Priority: HIGH
## Points: 3

## Background

Security audit revealed missing security headers in `netlify.toml`:
- No Content Security Policy (CSP)
- No Strict-Transport-Security (HSTS)

**Already configured:**
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- X-XSS-Protection: 1; mode=block
- Referrer-Policy: strict-origin-when-cross-origin
- Permissions-Policy: camera=(), microphone=(), geolocation=()

## Acceptance Criteria

- [ ] Content-Security-Policy header added to netlify.toml
- [ ] Strict-Transport-Security (HSTS) added to netlify.toml
- [ ] All headers verified in browser DevTools
- [ ] SecurityHeaders.com scan passes (A grade)
- [ ] Application functionality verified (no CSP violations)

## Technical Details

### Update netlify.toml

Update the existing security headers section in `netlify.toml`:

```toml
# Security headers
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"
    # ADD THESE TWO:
    Strict-Transport-Security = "max-age=31536000; includeSubDomains"
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' data:; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://api.anthropic.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests"
```

### Header Explanations

| Header | Value | Purpose |
|--------|-------|---------|
| Content-Security-Policy | See above | Prevents XSS, injection attacks |
| Strict-Transport-Security | max-age=31536000 | Forces HTTPS for 1 year |

### CSP Directives Explained

| Directive | Value | Reason |
|-----------|-------|--------|
| default-src | 'self' | Only load from same origin by default |
| script-src | 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com | Next.js requires inline/eval, PDF.js from CDN |
| style-src | 'self' 'unsafe-inline' | Tailwind CSS needs inline styles |
| img-src | 'self' data: https: blob: | Images from self, data URIs, HTTPS |
| font-src | 'self' data: | Fonts from self and data URIs |
| connect-src | 'self' https://*.supabase.co wss://*.supabase.co https://api.anthropic.com | API calls |
| frame-ancestors | 'none' | Prevent embedding in iframes |
| base-uri | 'self' | Restrict base tag |
| form-action | 'self' | Restrict form submissions |
| upgrade-insecure-requests | - | Force HTTPS for resources |

### CSP Report-Only Mode (Recommended for Testing)

Test CSP before enforcing by using report-only header first:

```toml
[[headers]]
  for = "/*"
  [headers.values]
    Content-Security-Policy-Report-Only = "default-src 'self'; ..."
```

Monitor browser console for CSP violations, then switch to enforcing mode.

## Verification

### Browser DevTools
1. Open DevTools â†’ Network tab
2. Reload page
3. Click on document request
4. Check Response Headers section
5. Verify CSP and HSTS headers present

### Online Scanners
- https://securityheaders.com - Enter site URL, expect A grade
- https://observatory.mozilla.org - Run scan

### curl Test
```bash
curl -I https://your-netlify-site.netlify.app

# Expected headers in response:
# content-security-policy: default-src 'self'...
# strict-transport-security: max-age=31536000...
# x-frame-options: DENY
# x-content-type-options: nosniff
```

### Functional Testing
After adding CSP, verify:
- [ ] Homepage loads correctly
- [ ] Chat/Assistant works
- [ ] PDF documents render
- [ ] Supabase connections work
- [ ] No errors in browser console

## Dependencies
- None

## Risks
- **CSP breaks functionality:** Test with report-only first
- **Third-party scripts blocked:** May need to whitelist additional sources
- **HSTS preload:** Only enable `preload` after confirming HTTPS works everywhere

## Notes
- PDF.js CDN (cdnjs.cloudflare.com) whitelisted in CSP
- Supabase WebSocket (wss://) needed for realtime features
- Review CSP quarterly as dependencies change
- Netlify automatically provides HTTPS
