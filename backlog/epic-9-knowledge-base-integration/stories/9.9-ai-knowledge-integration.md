# Story 9.9: AI Knowledge Base Integration

## User Story

**As a** homeowner asking the AI assistant questions
**I want** the AI to know about contacts, governance, and institutional knowledge
**So that** I can ask "who do I contact" questions and get accurate answers

## Description

Integrate the institutional knowledge (contacts, governance, board, etc.) into the AI assistant's context so it can accurately answer questions about who to contact, how the HOA is structured, and governance processes.

## Acceptance Criteria

- [ ] AI can answer "Who do I contact for..." questions
- [ ] AI knows property management contact info
- [ ] AI knows legal counsel info and escalation patterns
- [ ] AI knows board composition and authority
- [ ] AI can explain enforcement escalation
- [ ] AI references institutional knowledge in responses
- [ ] Context is efficiently formatted to minimize tokens

## Technical Details

### Context Integration

```typescript
// In src/lib/ai/build-context.ts

import {
  HOA_IDENTITY,
  CONTACTS,
  BOARD_MEMBERS,
  BOARD_AUTHORITY,
  ENFORCEMENT_PATH
} from '@/lib/data/institutional-knowledge';

export function buildInstitutionalContext(): string {
  return `
## HOA Identity
- Legal Name: ${HOA_IDENTITY.legalName}
- DBA: ${HOA_IDENTITY.dba}
- Type: ${HOA_IDENTITY.entityType}
- Units: ~${HOA_IDENTITY.totalUnits}

## Key Contacts

### Property Management
${CONTACTS.find(c => c.type === 'management')?.name}
- Address: PO Box 5800, Avon, CO 81620
- Email domains: @boldsolutions.net
- Platform: AppFolio
- Responsibilities: Day-to-day management, owner communications, maintenance, enforcement notices

### Legal Counsel
${CONTACTS.find(c => c.type === 'legal')?.name}
- Attorney: T.J. Voboril, Esq.
- Role: General counsel, collections, governance compliance
- Note: Escalated matters are often routed through counsel

### Insurance Broker
Mountain West Insurance & Financial Services, LLC
- Claims: claims@mtnwst.com
- Phone: 970-945-9111

## Board of Directors
${BOARD_MEMBERS.map(m => `- ${m.name}: ${m.position} (as of ${m.asOfDate})`).join('\n')}

Board Authority:
${BOARD_AUTHORITY.powers.map(p => `- ${p}`).join('\n')}

## Enforcement Escalation
1. Owner receives notice
2. Bold Property Management issues warning
3. Board reviews and decides on action
4. Alpenglow Law handles escalated matters

When answering "who do I contact" questions:
- Maintenance/access/notices → Bold Property Management
- Insurance claims → Mountain West Insurance
- Legal matters/disputes → Through property management, may escalate to Alpenglow Law
- Board decisions → Property management (board doesn't have direct contact)
`.trim();
}
```

### Update AI Context Builder

```typescript
// In src/lib/ai/build-context.ts

export function buildAIContext(query: string): string {
  const contexts: string[] = [];

  // Check if query is about contacts/governance
  const contactKeywords = ['contact', 'who', 'call', 'email', 'reach', 'management', 'board', 'attorney', 'lawyer'];
  const governanceKeywords = ['board', 'vote', 'decision', 'authority', 'governance', 'enforcement', 'escalat'];

  const queryLower = query.toLowerCase();

  if (contactKeywords.some(kw => queryLower.includes(kw)) ||
      governanceKeywords.some(kw => queryLower.includes(kw))) {
    contexts.push(buildInstitutionalContext());
  }

  // ... existing topic/document context building

  return contexts.join('\n\n---\n\n');
}
```

### System Prompt Updates

Add to the AI system prompt:

```typescript
// Additional system prompt content

const INSTITUTIONAL_GUIDANCE = `
When answering questions about contacts or who to reach:
- Be specific about which entity handles what
- Provide contact methods when known (email domains, phone)
- Explain escalation paths when relevant
- Note that the Board doesn't have direct public contact

When answering governance questions:
- Reference board authority from institutional knowledge
- Note "as of" dates for time-sensitive info like board members
- Explain decision-making processes accurately
`;
```

### Query Matching Examples

| User Query | Should Include |
|------------|---------------|
| "Who do I contact about a leak?" | Institutional context |
| "What's the property manager's email?" | Institutional context |
| "How do I reach the board?" | Institutional context |
| "What can the board do?" | Institutional context |
| "What happens if I get a violation?" | Institutional + enforcement |
| "When are assessments due?" | Financial topic (existing) |

## Story Points: 5

## Priority: High

## Dependencies

- Stories 9.1-9.6 (data structure must exist)
- Story 9.10 (data model)

## Definition of Done

- [ ] buildInstitutionalContext() function created
- [ ] Context integrated into AI context builder
- [ ] Keyword matching for contact/governance queries
- [ ] System prompt updated with guidance
- [ ] AI correctly answers "who to contact" questions
- [ ] AI knows board composition and authority
- [ ] AI explains enforcement escalation
- [ ] Context is token-efficient
- [ ] No regression in existing AI capabilities
