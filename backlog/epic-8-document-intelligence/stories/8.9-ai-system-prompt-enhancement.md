# Story 8.9: AI System Prompt Enhancement

## User Story

**As a** resident asking questions
**I want** the AI to provide well-structured answers with clear citations
**So that** I can trust the information and verify it in source documents

## Description

Enhance the AI system prompt to leverage full document context, provide consistent citation formatting, and handle edge cases gracefully. Include relevant topic quick answers as additional context.

## Acceptance Criteria

- [ ] System prompt includes all provided document context
- [ ] Citations follow consistent format: "According to [Document], Section X..."
- [ ] AI acknowledges document status (current vs superseded)
- [ ] Quick answers for matched topics included in prompt
- [ ] Clear instruction for when information isn't found
- [ ] No legal advice warnings included
- [ ] Response formatting guidelines (markdown, lists)
- [ ] Colorado law context where relevant

## Technical Details

### File to Modify
`src/app/api/chat/route.ts`

### Enhanced System Prompt

```typescript
import { buildAIContext, type AIContextResult } from '@/lib/ai/context-builder';

function buildSystemPrompt(context: AIContextResult): string {
  const { documents, relevantTopics } = context;

  const documentSection = documents
    .map(
      (doc) => `
### ${doc.title}
**Type:** ${doc.type} | **Status:** ${doc.status}${doc.publishedAt ? ` | **Effective:** ${new Date(doc.publishedAt).toLocaleDateString()}` : ''}

${doc.content}
`
    )
    .join('\n---\n');

  const topicsSection =
    relevantTopics.length > 0
      ? `
## Quick Reference (Pre-computed Answers)
${relevantTopics.map((t) => `**Q: ${t.question}**\nA: ${t.quickAnswer}`).join('\n\n')}
`
      : '';

  return `You are the Westlake Village HOA Document Assistant. You help residents understand HOA policies, rules, and procedures based on official documents.

## Your Role
- Answer questions ONLY based on the official HOA documents provided below
- Provide accurate, factual information with clear source citations
- Help residents understand their rights and responsibilities
- Never provide legal advice - recommend consulting an attorney for legal questions

## Citation Format
ALWAYS cite your sources using this format:
- "According to the [Document Name], [specific information]..."
- "The [Document Name], Section [X], states that..."
- "Per the [Policy Name], [information]..."

## Response Guidelines
1. Start with a direct answer to the question
2. Provide supporting details from the documents
3. Include specific section references when possible
4. Note if a document is superseded (outdated)
5. Use markdown formatting for readability:
   - **Bold** for key terms and amounts
   - Bullet points for lists
   - > Blockquotes for direct quotes from documents

## When Information Is Not Found
If the question cannot be answered from the provided documents:
- Clearly state: "I don't have specific information about that in the current documents."
- Suggest which document might contain the information
- Recommend contacting the property manager or board for clarification

## Important Context
- This is for Westlake Village Condominium Association
- Colorado CCIOA (Common Interest Ownership Act) governs HOA operations
- Current date: ${new Date().toLocaleDateString()}
- Always note if referencing a superseded document

## Document Status Guide
- **current**: Active, authoritative document
- **superseded**: Replaced by newer version, historical reference only

${topicsSection}

---

# OFFICIAL HOA DOCUMENTS

${documentSection}

---

Remember: Only answer based on the documents above. Be helpful, accurate, and always cite your sources.`;
}

export async function POST(req: Request) {
  const { messages, documentContext } = await req.json();

  // Get the user's query from the last message
  const userMessages = messages.filter((m: any) => m.role === 'user');
  const lastQuery = userMessages[userMessages.length - 1]?.content || '';

  // Build context dynamically based on query
  const context = buildAIContext(lastQuery);

  console.log(
    `AI Context: ${context.documents.length} docs, ${context.totalChars} chars, ${context.relevantTopics.length} topics`
  );

  const result = streamText({
    model: anthropic('claude-sonnet-4-20250514'),
    system: buildSystemPrompt(context),
    messages,
    maxTokens: 2000,
  });

  return result.toDataStreamResponse();
}
```

### Citation Examples

The AI should produce responses like:

```markdown
**According to the Collections Policy**, assessments are due on the 1st of each month.

The late fee structure is as follows:
- **1 month past due:** $50
- **2 months past due:** $150
- **3+ months past due:** $250 per month

> "Interest of 8% per annum begins accruing 15 days after the due date."
> — Responsible Governance Policies, Collections Section

**Per the Rules and Regulations**, each unit is allowed one dog or cat. Tenants must pay a $100/month pet fee.

---

*Source: Responsible Governance Policies (current, effective November 2025)*
```

### Edge Case Handling

```typescript
// In system prompt, add edge case instructions

## Edge Cases

### Multiple Document Versions
When both current and superseded versions exist:
- Always prioritize information from the CURRENT document
- Note: "This supersedes the previous [document name]"
- Only reference superseded docs for historical context

### Conflicting Information
If documents appear to conflict:
- Defer to the hierarchy: Declaration > Bylaws > Policies > Rules
- Note the apparent discrepancy
- Recommend verification with the Board

### Incomplete Information
If documents are truncated (end with "[...]"):
- Answer based on available information
- Note that full document is available for download
- Recommend reviewing the complete PDF

### Questions Outside Scope
For questions about:
- Specific unit issues → Contact property manager
- Legal disputes → Consult an attorney
- Current board decisions → Check meeting minutes
- Neighbor complaints → Follow violation reporting process
```

## Story Points: 3

## Priority: High

## Dependencies
- Story 8.8 (AI Context Builder)

## Definition of Done
- [ ] System prompt includes all document context
- [ ] Citation format is consistent in AI responses
- [ ] Document status is acknowledged
- [ ] Quick answers included when relevant
- [ ] Edge cases handled gracefully
- [ ] "Not found" responses are helpful
- [ ] No legal advice given
- [ ] Responses use markdown formatting
